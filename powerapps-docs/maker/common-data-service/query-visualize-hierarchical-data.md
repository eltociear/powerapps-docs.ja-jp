---
title: PowerApps を使用する階層データのクエリおよび視覚化 | MicrosoftDocs
description: 関連する階層データをクエリおよびビジュアル化する方法を学習します
ms.custom: ''
ms.date: 06/20/2018
ms.reviewer: ''
ms.service: powerapps
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
applies_to:
  - Dynamics 365 (online)
  - Dynamics 365 Version 9.x
  - powerapps
author: Mattp123
ms.assetid: 0cf62817-5ff5-40bb-ad17-e1f6b0921720
caps.latest.revision: 42
ms.author: matp
manager: kvivek
search.audienceType:
  - maker
search.app:
  - PowerApps
  - D365CE
---
# <a name="query-and-visualize-hierarchically-related-data"></a>階層的に関連するデータのクエリと視覚化

関連データの階層的なビジュアル化で、役に立つ業務把握が可能です。 階層モデル化およびビジュアル化の機能には、以下に示すさまざまな利点があります。  
  
-   複雑な階層情報を表示および検証します。  
  
-   主要業績評価指標 (KPI) を階層のコンテキスト ビューに表示します。  
  
-   Web およびタブレット PC 全体の主要な情報を視覚的に分析します。  
  
取引先企業およびユーザーなどの一部のエンティティについては、ビジュアル化が既定で設定されています。 任意の階層にのユーザー定義エンティティを含むそのほかのエンティティを有効にし、それらのビジュアル化を作成することができます。 ユーザーは、必要に応じて、階層全体を表示するツリー ビューか、または階層のより小さい部分を表示するタイル表示を選択できます。 両方のビューは並んで表示されます。 階層ツリーを展開および折りたたむことで、階層を調べることができます。 ビジュアル化のための同じ階層設定は一度に設定されますが、Web とモバイル クライアントの両方に適用されます。 タブレット PC では、ビジュアルは小さいフォーム ファクターに最適な修正した形式で作成されます。 階層のビジュアル化に必要なカスタマイズ可能なコンポーネントはソリューションに対応しているため、そのほかのカスタマイズのように、組織間で移動できます。 簡易入力フォームをフォーム エディターでカスタマイズして、ビジュアル化に表示される属性を構成できます。 コードを作成する必要はありません。  
  
<a name="BKMK_Querydata"></a>   
## <a name="query-hierarchical-data"></a>クエリ階層型データ  
 Common Data Service では、階層データ構造は、関連レコードの自己参照の関連付けでサポートされます。 以前は、階層データを表示するには、関連レコードのクエリを繰り返す必要がありました。 現在は、関連データを階層として 1 回の手順でクエリすることができます。 レコードを**に属する**と**に属さない**のロジックを使用してクエリできます。 **に属する**と**に属さない**の階層演算子は、高度な検索やワークフロー エディタで公開されます。 これらの演算子の使用方法の詳細については、[ワークフロー ステップの構成](/flow/configure-workflow-steps) を参照してください。 高度な検索の詳細については、「[高度な検索の作成、編集または保存](https://docs.microsoft.com/dynamics365/customer-engagement/basics/save-advanced-find-search)」を参照してください。  
  
 階層クエリのさまざまなシナリオを示した例を以下に紹介します。  
  
 取引先企業階層のクエリ  
  
 ![取引先企業階層クエリの取引先企業](media/query-accounts.png "取引先企業階層クエリの取引先企業")  
  
 関連する活動を含む取引先企業のクエリ  
  
 ![クエリの取引先企業に関する活動](media/query-account-related-activities.png "クエリの取引先企業に関する活動")  
  
 関連する営業案件を含む取引先企業のクエリ  
  
 ![クエリの取引先企業に関する営業案件](media/query-account-related-opportunities.png "クエリの取引先企業に関する営業案件")  
  
 データを階層としてクエリするには、エンティティの 1 対多または多対 1 の自己参照の関連付けのひとつを階層として設定する必要があります。 階層の有効化:  
  

1. [powerapps.com](https://web.powerapps.com/?utm_source=padocs&utm_medium=linkinadoc&utm_campaign=referralsfromdoc) で**データ**セクションを展開し、左側のナビゲーション ウィンドウで**エンティティ**をクリックまたはタップします。

2. 既存のエンティティ、または [エンティティの新規作成](data-platform-create-entity.md) をクリックまたはタップします

3. **関連付け**をクリックします

4.  自己参照の関連付けを選択してください。

5.  関連付けの詳細パネルで **階層** を確認します。  
  
> [!NOTE]
> - 一部の初期状態の関連付けはカスタマイズできません。 これにより、これらの関連付けを階層として設定することはできません。  
> - 自己参照の関連付けシステムには、階層型の関連付けを指定できます。 これには "contact_master_contact" 関連付けなど、システム タイプの自己参照の関連付けが含まれます。  
  
<a name="BKMK_Visualizedata"></a>   
## <a name="visualize-hierarchical-data"></a>階層データをビジュアル化する  
 ビジュアル化が既定で利用できるシステム エンティティとして、`Account`、`Position`、`Product`、および`User`があります。 これらのエンティティ グリッド ビューには、レコード名の左側に階層グラフを表示するアイコンが表示されます。 階層アイコンは既定ではすべてレコードに存在するわけではありません。 このアイコンは、親レコード、子レコードまたは両方のレコードを持つレコードに表示されます。  
 
 > [!div class="mx-imgBorder"] 
 > ![アクティブな取引先企業](media/cust-hs-active-account.png "アクティブな取引先企業")  
  
 階層アイコンを選択すると、次に示すように、左側にツリー ビュー、右側にタイルビューの形で階層を表示できます。  
  
> [!div class="mx-imgBorder"] 
> ![取引先企業ツリーとタイル ビュー](media/hierachy-security-accounts-tile-view.png "取引先企業ツリーとタイル ビュー")  
  
 階層のいくつかのそのほかの既定のシステム エンティティを有効にすることができます。 これらのエンティティには、`Case`、 `Contact`、`Opportunity`、`Order`、`Quote`、`Campaign`、 `Team`があります。 階層のすべてのユーザー定義エンティティは有効にすることができます。  
  
> [!TIP]
>  階層のエンティティを有効にすることができる場合、次の手順を実行します。  
>  ソリューション エクスプローラーで、目的のエンティティを展開します。 **階層設定**というエンティティ コンポーネントが表示されます。 階層に対して有効化できないエンティティには、Dynamics 365 Sales の担当地域エンティティを除けば、このコンポーネントはありません。 **階層設定**が営業担当地域エンティティに対して表示されますが、このエンティティは階層に対して有効化できません。  
  
 ビジュアル化の作成で重要な留意点は次のとおりです。  
  
-   各エンティティについて (1:N) の自己参照の関連付けを 1 つだけ階層として設定できます。 この関連付けでは、主エンティティおよび関連エンティティは、account_parent_account または Widget_new_Widget_new_Widget などの同じ種類である必要があります。  
  
-   現在は、階層またはビジュアル化は 1 つのエンティティのみに基づいています。 取引先企業を複数レベルで示す取引先企業階層を表現することはできますが、取引先企業と取引先担当者を同じ階層型ビジュアル化に表示することはできません。  
  
-   タイルに表示できる最大のレコード数は 4 です。 タイル ビューに使用される簡易入力フォームに複数のフィールドを追加すると、最初の 4 つのフィールドだけが表示されます。  
  
### <a name="visualization-example"></a>ビジュアル化の例  
 ユーザー定義エンティティのビジュアル化の作成の例を見てみましょう。 ここで示すように、new_Widget というカスタム エンティティを作成し、自己参照の関連付けを作成し、それを階層としてマークします。  
 
> [!div class="mx-imgBorder"] 
> ![ウィジェット関連付けの定義](media/widget-relationship-definition.png "ウィジェット関連付けの定義")  
   
 次に、**階層設定** グリッド ビューで、**Widget_new_Widget_new_Widget** という階層の関連付けを選択しました。 フォームの必須フィールドに入力しました。 まだ関連付けを階層としてマークしていない場合は、フォーム上のリンクをクリックから従来のエンティティエディタに移動して、関連付けを階層としてマークすることもできます。  
  
 **簡易表示フォーム**について、**ウィジェットの階層タイル フォーム**という名前の簡易入力フォームを作成しました。 このフォームで、各タイルに表示する 4 つのフィールドを追加しました。  
  
> [!div class="mx-imgBorder"] 
> ![ウィジェットの簡易入力フォームを作成する](media/create-quickf-orm.png "ウィジェットの簡易入力フォームを作成する")  
  
 このセットアップが完了した後、Standard Widget と Premium Widget という 2 つのレコードを作成しました。 Premium Widget を検索フィールドを使用して Standard Widget の親にした後、以下に示すように、new_Widget グリッド ビューに階層アイコンが表示されました。  
  
> [!div class="mx-imgBorder"] 
> ![ウィジェットの階層グリッド](media/widget-hierarchy-grid.png "ウィジェットの階層グリッド")  
  
> [!TIP]
>  階層アイコンは、レコードが親子関係で関連付けられるまで、レコード グリッド ビューに表示されません。  
  
 階層アイコンを選択すると、左側にツリー ビュー、右側にタイルビューの形で、2 つのレコードを示す new_Widget 階層が表示されます。 各タイルには、**ウィジェットの階層タイル フォーム**で指定した 4 つのフィールドが含まれています。  
 
 > [!div class="mx-imgBorder"] 
 > ![ウィジェットのツリーとタイルの表示](media/widget-tree-tiles.png "ウィジェットのツリーとタイルの表示")  
  
## <a name="see-also"></a>関連項目  
 [ビデオ: 階層セキュリティ モデル](http://www.youtube.com/watch?v=kx5So32DrCo&index=10&list=PLC3591A8FE4ADBE07)   
 [ビデオ: 階層ビジュアル化](http://www.youtube.com/watch?v=_dGBE6icLNw&index=9&list=PLC3591A8FE4ADBE07)
